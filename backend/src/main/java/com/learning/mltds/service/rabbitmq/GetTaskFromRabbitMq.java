package com.learning.mltds.service.rabbitmq;

import com.alibaba.fastjson.JSONObject;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.learning.mltds.config.CommonConfig;
import com.learning.mltds.dto.DetectionResultDTO;
import com.learning.mltds.utils.rabbitmq.ConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.GetResponse;
import org.springframework.amqp.rabbit.connection.CachingConnectionFactory;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class GetTaskFromRabbitMq {
    private GetResponse response;
    private static String exchange = CommonConfig.exchange;
    // 用于解析json格式的
    @Resource
    private ObjectMapper objectMapper;

    @Resource
    private CachingConnectionFactory connectionFactory;

    // 从rabbitMq中接收消息
    public List<DetectionResultDTO> getMessage(String queue, String routingKey){
        //1 创建一个ConnectionFactory,并进行配置
        Channel channel;
        Map<String, Object> messageMap = null;

        try {
            connectionFactory = ConnectionUtil.cachingConnectionFactory();
            Connection connection = connectionFactory.getRabbitConnectionFactory().newConnection();
            //3 通过connection创建一个channel
            channel = connection.createChannel();
            try {
                //2 通过连接工厂创建连接
                //4 声明（创建）一个队列
                String exchangeName = exchange;
                //是否持久化
                boolean durable = true;
                boolean exclusive = false;
                boolean autoDelete = false;
                // 这俩应该是创建消费者，先取消了
//                channel.exchangeDeclare(exchangeName, MODE, true, false, null);
//                channel.queueDeclare(queue, durable, exclusive, autoDelete, null);
                channel.queueBind(queue, exchangeName, routingKey);

                //5 创建消费者
                // Step06: let the consumer consume the queue
                /*
                 * 启动一个消费者，并返回服务端生成的消费者标识
                 * queue:队列名
                 * autoAck：true 接收到传递过来的消息后acknowledged（应答服务器），false 接收到消息后不应答服务器
                 * callback: 消费者对象的回调接口
                 * @return 服务端生成的消费者标识
                 */
                // 当队列中含有消息是自动消费
                // channel.basicConsume(queue, true, new MyConsumer(channel));


                // * queue:队列名
                // * autoAck：true 接收到传递过来的消息后acknowledged（应答服务器），false 接收到消息后不主动应答服务器
                // 获得队列中的一条消息，调用一次获得第一个，调用2次获得第二个，若队列中没有消息则报错，
                response = channel.basicGet(queue, false);
                // 接受到队列中的消息，并返回结果
                String message = new String(response.getBody(), StandardCharsets.UTF_8);
//                System.out.println(message);
//                // 由于接受到的String是带有\\反转义字符的，因此要清除这些反转义字符
//                message = message.replace("\"{", "{");
//                message = message.replace("}\"", "}");
//                String message_clear = StringEscapeUtils.unescapeJava(message);
//                // 对String进行反序列化，转json
//                result = objectMapper.readValue(message_clear, Map.class);
//                System.out.println("消费者接收到的消息：" + result);

                // 获取message中的"result"对应的值，并转为 Map 对象返回
                final JSONObject jsonObject = JSONObject.parseObject(message);
                message = (String) jsonObject.get("result");
                // TODO
                messageMap = (Map<String, Object>) objectMapper.readValue(message, Map.class);
            }
            // 防止消息因channel没有关闭而造成的消息丢失,连接也关闭了吧，释放点资源
            catch (Exception e){
                e.printStackTrace();
                channel.close();
                connection.close();
                throw new Exception();
            }
            channel.close();
            connection.close();
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println("消费者获取消息失败");
            return new ArrayList<>();
        }

        // 将message转化为DetectionResultDTO，并加入结果数组
        // messageMap : { "filename" : {}, ...}

        List<DetectionResultDTO> result = new ArrayList<>();
        for(String filename: messageMap.keySet()){
            Map<String, Object> data = (Map<String, Object>) messageMap.get(filename);
            Map<String, Object> imageinfoMap = (Map<String, Object>) data.get("image_info");
            List<Map<String, Object>> objectinfosMap = (List<Map<String, Object>>) data.get("object_infos");
            result.add(new DetectionResultDTO(imageinfoMap, objectinfosMap));
        }

        return result;
    }

    public static void main(String[] args) {
//        GetTaskFromRabbitMq getTaskFromRabbitMq = new GetTaskFromRabbitMq();
//        getTaskFromRabbitMq.getMessage("9c26c48fc09844bd8693cbb5c54cb2f8", "9c26c48fc09844bd8693cbb5c54cb2f8");
        String data = "{\"task_id\": \"9c26c48f-c098-44bd-8693-cbb5c54cb2f8\", \"status\": \"SUCCESS\", \"result\": \"{\\\"Google-1m_1_1\\\": {\\\"image_info\\\": {\\\"image_width\\\": 17855, \\\"im_height\\\": 16671, \\\"sat_type\\\": \\\"Google-1m\\\", \\\"sensor_type\\\": \\\"1\\\", \\\"filename\\\": \\\"Google-1m_1_1\\\", \\\"path\\\": \\\"/home/yiyonghao/geoserver_data/yyh/task-image/Google-1m_1_1.tiff\\\", \\\"is_detected\\\": true, \\\"detect_time\\\": \\\"2022-10-30 10:14:45\\\"}, \\\"object_infos\\\": [{\\\"bbox\\\": [5001, 6576, 4977, 6737, 4287, 6635, 4311, 6474], \\\"geo_bbox\\\": [-76.42359673976898, 36.95569038391113, -76.4237254858017, 36.95482671260834, -76.42742693424225, 36.955373883247375, -76.42729818820953, 36.95623755455017], \\\"classname\\\": \\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", \\\"confidence\\\": 0.9999936819173456, \\\"image_center\\\": [4644, 6605], \\\"geo_center\\\": [-76.42551183700562, 36.9555321361986], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 8, \\\"detected_time\\\": \\\"2022-10-30 10:14:45\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_0.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_0_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_0_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", 0.9999936819173456], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 2.5802508078446456e-06], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u970d\\\\u666e\\\\u7ea7\\\", 2.6028400503313907e-08]]}, {\\\"bbox\\\": [4447, 7597, 4442, 7627, 4088, 7570, 4093, 7540], \\\"geo_bbox\\\": [-76.42656862735748, 36.95021331310272, -76.42659544944763, 36.95005238056183, -76.42849445343018, 36.950358152389526, -76.42846763134003, 36.95051908493042], \\\"classname\\\": \\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", \\\"confidence\\\": 0.9999961853027344, \\\"image_center\\\": [4267, 7583], \\\"geo_center\\\": [-76.42753154039383, 36.950285732746124], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 9, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_1.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_1_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_1_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 0.9999961853027344], [\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 4.664275663811712e-22], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 6.640025168741754e-23]]}, {\\\"bbox\\\": [4880, 7407, 4872, 7458, 4485, 7400, 4493, 7349], \\\"geo_bbox\\\": [-76.42424583435059, 36.95123255252838, -76.42428874969482, 36.95095896720886, -76.42636477947235, 36.95127010345459, -76.42632186412811, 36.95154368877411], \\\"classname\\\": \\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999948740005493, \\\"image_center\\\": [4682, 7403], \\\"geo_center\\\": [-76.42530531215016, 36.951251327991486], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 8, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_2.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_2_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_2_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 0.9999948740005493], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u5965\\\\u65af\\\\u6c40\\\\u7ea7\\\", 5.262919766926103e-21], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 7.275927388267303e-24]]}, {\\\"bbox\\\": [5214, 5697, 5194, 5829, 4504, 5727, 4523, 5595], \\\"geo_bbox\\\": [-76.42245411872864, 36.960405707359314, -76.42256140708923, 36.95969760417938, -76.42626285552979, 36.96024477481842, -76.42616093158722, 36.96095287799835], \\\"classname\\\": \\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", \\\"confidence\\\": 0.9999939203282793, \\\"image_center\\\": [4858, 5712], \\\"geo_center\\\": [-76.42435981775634, 36.96032504463801], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 8, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_3.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_3_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_3_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", 0.9999939203282793], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 3.717133882839255e-07], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u970d\\\\u666e\\\\u7ea7\\\", 2.2301270451962734e-08]]}, {\\\"bbox\\\": [3838, 10354, 3836, 10326, 4208, 10309, 4210, 10336], \\\"geo_bbox\\\": [-76.42983555793762, 36.935423612594604, -76.42984628677368, 36.93557381629944, -76.4278507232666, 36.935665011405945, -76.42783999443054, 36.93552017211914], \\\"classname\\\": \\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", \\\"confidence\\\": 0.9999932050704956, \\\"image_center\\\": [4023, 10330], \\\"geo_center\\\": [-76.42884314060211, 36.93554699944798], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -2, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_4.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_4_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_4_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 0.9999932050704956], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u5723\\\\u5b89\\\\u4e1c\\\\u5c3c\\\\u5965\\\\u7ea7\\\", 3.442747035515203e-19], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 1.904764546524593e-19]]}, {\\\"bbox\\\": [5219, 5915, 5214, 5951, 4891, 5905, 4896, 5869], \\\"geo_bbox\\\": [-76.42242729663849, 36.95923626422882, -76.42245411872864, 36.95904314517975, -76.42418682575226, 36.95928990840912, -76.42416000366211, 36.95948302745819], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999920129776001, \\\"image_center\\\": [5054, 5910], \\\"geo_center\\\": [-76.42330706381472, 36.95926308631897], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 8, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_5.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_5_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_5_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999920129776001], [\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 6.337731236156869e-19], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 3.042382141963757e-21]]}, {\\\"bbox\\\": [3912, 8878, 3909, 8824, 4344, 8800, 4347, 8854], \\\"geo_bbox\\\": [-76.42943859100342, 36.94334149360657, -76.42945468425751, 36.943631172180176, -76.42712116241455, 36.94375991821289, -76.42710506916046, 36.94347023963928], \\\"classname\\\": \\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", \\\"confidence\\\": 0.9999878406524658, \\\"image_center\\\": [4127, 8838], \\\"geo_center\\\": [-76.42827987932833, 36.94355071114842], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -3, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_6.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_6_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_6_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 0.9999878406524658], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 2.032073400045821e-14], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 7.520729806823188e-19]]}, {\\\"bbox\\\": [4421, 10628, 4419, 10589, 4747, 10572, 4749, 10611], \\\"geo_bbox\\\": [-76.42670810222626, 36.93395376205444, -76.42671883106232, 36.934162974357605, -76.42495930194855, 36.93425416946411, -76.42494857311249, 36.93404495716095], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999866485595703, \\\"image_center\\\": [4584, 10600], \\\"geo_center\\\": [-76.4258337020874, 36.9341039552819], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -2, \\\"detected_time\\\": \\\"2022-10-30 10:14:46\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_7.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_7_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_7_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999866485595703], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 2.2881756547079266e-19], [\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 2.8313771994932616e-20]]}, {\\\"bbox\\\": [4094, 10741, 4091, 10678, 4654, 10647, 4658, 10711], \\\"geo_bbox\\\": [-76.428462266922, 36.93334758281708, -76.42847836017609, 36.933685541152954, -76.42545819282532, 36.93385183811188, -76.4254367351532, 36.93350851535797], \\\"classname\\\": \\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u533b\\\\u9662\\\\u8239\\\", \\\"confidence\\\": 0.9999833106994629, \\\"image_center\\\": [4374, 10693], \\\"geo_center\\\": [-76.42695863469271, 36.93359978904482], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -3, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_8.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_8_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_8_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u533b\\\\u9662\\\\u8239\\\", 0.9999833106994629], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 1.7875618339176193e-12], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 5.779497756449814e-15]]}, {\\\"bbox\\\": [3882, 8773, 3881, 8736, 4211, 8721, 4212, 8758], \\\"geo_bbox\\\": [-76.42959952354431, 36.943904757499695, -76.42960488796234, 36.9441032409668, -76.42783463001251, 36.944183707237244, -76.42782926559448, 36.94398522377014], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999817609786987, \\\"image_center\\\": [4046, 8747], \\\"geo_center\\\": [-76.42871707415907, 36.94404423236847], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -2, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_9.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_9_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_9_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999817609786987], [\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 3.709171126281207e-20], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 9.411829021142235e-22]]}, {\\\"bbox\\\": [3918, 10271, 3916, 10232, 4234, 10212, 4236, 10251], \\\"geo_bbox\\\": [-76.42940640449524, 36.93586885929108, -76.4294171333313, 36.93607807159424, -76.42771124839783, 36.936185359954834, -76.42770051956177, 36.93597614765167], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.999980092048645, \\\"image_center\\\": [4076, 10241], \\\"geo_center\\\": [-76.42855882382719, 36.936027104384266], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -3, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_10.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_10_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_10_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.999980092048645], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 1.379653340043259e-18], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 8.177726655472118e-20]]}, {\\\"bbox\\\": [4643, 7251, 4636, 7306, 4156, 7249, 4163, 7194], \\\"geo_bbox\\\": [-76.42551720142365, 36.95206940174103, -76.42555475234985, 36.95177435874939, -76.42812967300415, 36.95208013057709, -76.42809212207794, 36.952375173568726], \\\"classname\\\": \\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", \\\"confidence\\\": 0.9999716281890869, \\\"image_center\\\": [4399, 7250], \\\"geo_center\\\": [-76.4268234372139, 36.95207476615906], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 6, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_11.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_11_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_11_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 0.9999716281890869], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u533b\\\\u9662\\\\u8239\\\", 3.231198726382921e-16], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 2.85185143923179e-22]]}, {\\\"bbox\\\": [4416, 10332, 4413, 10297, 4726, 10274, 4728, 10309], \\\"geo_bbox\\\": [-76.4267349243164, 36.93554162979126, -76.4267510175705, 36.9357293844223, -76.42507195472717, 36.93585276603699, -76.42506122589111, 36.935665011405945], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999676942825317, \\\"image_center\\\": [4570, 10303], \\\"geo_center\\\": [-76.4259045815561, 36.93569711409509], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -4, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_12.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_12_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_12_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999676942825317], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 8.297532048334928e-21], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 2.431253872825384e-22]]}, {\\\"bbox\\\": [3960, 8444, 3959, 8411, 4279, 8400, 4281, 8434], \\\"geo_bbox\\\": [-76.42918109893799, 36.945669651031494, -76.42918646335602, 36.94584667682648, -76.42746984958649, 36.945905685424805, -76.42745912075043, 36.94572329521179], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999549388885498, \\\"image_center\\\": [4119, 8421], \\\"geo_center\\\": [-76.42832295183325, 36.94578774680849], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -1, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_13.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_13_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_13_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999549388885498], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 2.616509968154147e-17], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 6.857697570742923e-19]]}, {\\\"bbox\\\": [4404, 10242, 4401, 10202, 4718, 10186, 4720, 10226], \\\"geo_bbox\\\": [-76.42679929733276, 36.93602442741394, -76.42681539058685, 36.93623900413513, -76.42511487007141, 36.93632483482361, -76.42510414123535, 36.93611025810242], \\\"classname\\\": \\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", \\\"confidence\\\": 0.9999549388885498, \\\"image_center\\\": [4560, 10214], \\\"geo_center\\\": [-76.42595970828552, 36.93617450015154], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -2, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_14.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_14_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_14_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 0.9999549388885498], [\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 4.4972697328037125e-18], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 1.8028521674900786e-18]]}, {\\\"bbox\\\": [3801, 9331, 3800, 9299, 4170, 9289, 4171, 9321], \\\"geo_bbox\\\": [-76.43003404140472, 36.940911412239075, -76.43003940582275, 36.94108307361603, -76.42805457115173, 36.941136717796326, -76.4280492067337, 36.94096505641937], \\\"classname\\\": \\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", \\\"confidence\\\": 0.9999113082885742, \\\"image_center\\\": [3985, 9310], \\\"geo_center\\\": [-76.42904430496856, 36.9410240650177], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -1, \\\"detected_time\\\": \\\"2022-10-30 10:14:47\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_15.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_15_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_15_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u5de1\\\\u6d0b\\\\u8230\\\", \\\"\\\\u63d0\\\\u5eb7\\\\u5fb7\\\\u7f57\\\\u52a0\\\\u7ea7\\\", 0.9999113082885742], [\\\"\\\\u9a71\\\\u9010\\\\u8230\\\", \\\"\\\\u4f2f\\\\u514b\\\\u7ea7\\\", 1.6761186748510082e-18], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 1.0212072204373778e-19]]}, {\\\"bbox\\\": [12248, 10179, 12248, 10100, 12738, 10098, 12738, 10178], \\\"geo_bbox\\\": [-76.38472080230713, 36.93636238574982, -76.38472080230713, 36.93678617477417, -76.38209223747253, 36.93679690361023, -76.38209223747253, 36.93636775016785], \\\"classname\\\": \\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", \\\"confidence\\\": 0.9829635988779799, \\\"image_center\\\": [12493, 10138], \\\"geo_center\\\": [-76.38340651988983, 36.93657964991871], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 0, \\\"detected_time\\\": \\\"2022-10-30 10:14:48\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_16.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_16_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_16_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", 0.9829635988779799], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 0.011464324742927468], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 0.0002495242006696763]]}, {\\\"bbox\\\": [17742, 11214, 17739, 11273, 17343, 11256, 17346, 11197], \\\"geo_bbox\\\": [-76.35524868965149, 36.93081021308899, -76.35526478290558, 36.93049371242523, -76.35738909244537, 36.93058490753174, -76.35737299919128, 36.930901408195496], \\\"classname\\\": \\\"\\\\u62a4\\\\u536b\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f69\\\\u91cc\\\\u7ea7\\\", \\\"confidence\\\": 0.42426346446083585, \\\"image_center\\\": [17542, 11235], \\\"geo_center\\\": [-76.35631889104843, 36.930697560310364], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": 2, \\\"detected_time\\\": \\\"2022-10-30 10:14:48\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_17.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_17_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_17_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u62a4\\\\u536b\\\\u8230\\\", \\\"\\\\u4f69\\\\u91cc\\\\u7ea7\\\", 0.42426346446083585], [\\\"\\\\u4e24\\\\u6816\\\\u8230\\\", \\\"\\\\u60e0\\\\u5fb7\\\\u8d1d\\\\u5c9b\\\\u7ea7\\\", 0.032087128544417975], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u51ef\\\\u6cfd\\\\u7ea7\\\", 0.0159135521499294]]}, {\\\"bbox\\\": [12279, 10107, 12278, 10058, 12719, 10047, 12720, 10096], \\\"geo_bbox\\\": [-76.3845545053482, 36.93674862384796, -76.38455986976624, 36.93701148033142, -76.3821941614151, 36.93707048892975, -76.38218879699707, 36.93680763244629], \\\"classname\\\": \\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"typename\\\": \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", \\\"confidence\\\": 0.39241121501788356, \\\"image_center\\\": [12499, 10076], \\\"geo_center\\\": [-76.38337433338165, 36.936909561627544], \\\"length\\\": 0.0, \\\"width\\\": 0.0, \\\"angle\\\": -1, \\\"detected_time\\\": \\\"2022-10-30 10:14:48\\\", \\\"task_id\\\": 16, \\\"target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_18.jpg\\\", \\\"area_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_18_area.jpg\\\", \\\"fix_target_slice_path\\\": \\\"/home/yiyonghao/mltds-new/backend/mltds/static/mltds/detection/1/16/Google-1m_1_1_18_fix.jpg\\\", \\\"candidate\\\": [[\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u4f9b\\\\u5e94\\\\u7ea7\\\", 0.39241121501788356], [\\\"\\\\u8865\\\\u7ed9\\\\u8230\\\", \\\"\\\\u533b\\\\u9662\\\\u8239\\\", 6.199160203361135e-08], [\\\"\\\\u822a\\\\u7a7a\\\\u6bcd\\\\u8230\\\", \\\"\\\\u5c3c\\\\u7c73\\\\u5179\\\\u7ea7\\\", 4.606936477170653e-09]]}]}}\", \"traceback\": null, \"children\": []}";
        System.out.println(data);
        final JSONObject jsonObject = JSONObject.parseObject(data);
        data = (String) jsonObject.get("result");
        System.out.println(data);
        ObjectMapper objectMapper = new ObjectMapper();
        try {
            Map result = objectMapper.readValue(data, Map.class);
            for(Object key:result.keySet())
                System.out.println(key.toString() + ": " + result.get(key));
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
        // jsonresult -> HashMap


//        final Map<String, Object> result = (Map<String, Object>) jsonObject.get("result");

        try{
//            for(String key:result.){
//                System.out.println(key + ": " + result.get(key));
//            }
//            final Task task = JSONObject.parseObject(result, Task.class);
//            System.out.println(result);
        }catch (Exception e){
            System.out.println("报错");
        }
    }
}
